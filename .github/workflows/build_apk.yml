name: Build APK (Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK on Ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip python3-pip python3-venv build-essential libssl-dev libffi-dev git openjdk-11-jdk

      - name: Install Android SDK command-line tools
        run: |
          ANDROID_HOME=${RUNNER_TEMP}/android-sdk
          mkdir -p $ANDROID_HOME/cmdline-tools
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools/tmp
          mv $ANDROID_HOME/cmdline-tools/tmp/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          rm cmdline-tools.zip
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --sdk_root=$ANDROID_HOME --licenses
          # install common packages and a newer build-tools that Buildozer may request
          sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-31" "build-tools;31.0.0" "build-tools;36.1.0" "ndk;25.2.9519653"
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV

      - name: Set Android env vars
        run: |
          ANDROID_HOME=${RUNNER_TEMP}/android-sdk
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          ndkdir=$(ls -d $ANDROID_HOME/ndk/* | sort -V | tail -n1)
          echo "ANDROID_NDK_ROOT=$ndkdir" >> $GITHUB_ENV

      - name: Create Python venv and install Buildozer
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install buildozer==1.5.0 cython

      - name: Prepare .buildozer SDK and accept licenses
        run: |
          # Ensure Buildozer's local SDK directory has the commandline tools and accepted licenses
          mkdir -p ./.buildozer/android/platform/android-sdk/cmdline-tools
          cp -r ${RUNNER_TEMP}/android-sdk/cmdline-tools/latest ./.buildozer/android/platform/android-sdk/cmdline-tools/
          export PATH=./.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin:$PATH
          # Copy pre-installed packages (build-tools, platform-tools, platforms, ndk) into Buildozer's SDK so sdkmanager won't need to install them there
          mkdir -p ./.buildozer/android/platform/android-sdk
          cp -r ${RUNNER_TEMP}/android-sdk/build-tools ./.buildozer/android/platform/android-sdk/ || true
          cp -r ${RUNNER_TEMP}/android-sdk/platform-tools ./.buildozer/android/platform/android-sdk/ || true
          cp -r ${RUNNER_TEMP}/android-sdk/platforms ./.buildozer/android/platform/android-sdk/ || true
          cp -r ${RUNNER_TEMP}/android-sdk/ndk ./.buildozer/android/platform/android-sdk/ || true
          # Accept any SDK licenses non-interactively (may exit non-zero if already accepted)
          yes | sdkmanager --sdk_root=./.buildozer/android/platform/android-sdk --licenses || true
          # Double-check required package presence
          ls -la ./.buildozer/android/platform/android-sdk/build-tools || true
          ls -la ./.buildozer/android/platform/android-sdk/platform-tools || true
          ls -la ./.buildozer/android/platform/android-sdk/platforms || true
          ls -la ./.buildozer/android/platform/android-sdk/ndk || true

      - name: Show repo files (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la
          git rev-parse --show-toplevel || true
          echo "Checking for buildozer.spec..."
          if [ -f buildozer.spec ]; then echo "FOUND buildozer.spec"; head -n 40 buildozer.spec; else echo "buildozer.spec not found"; fi

      - name: Build APK (debug)
        run: |
          source .venv/bin/activate
          buildozer -v android debug || (echo "Buildozer failed, dumping log" && tail -n 200 .buildozer/android/platform/build/dists/*/log.txt && exit 1)
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_ROOT: ${{ env.ANDROID_NDK_ROOT }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: bin/*.apk
